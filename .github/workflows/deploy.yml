name: Deploy

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
  workflow_dispatch:

permissions:
  contents: write

env:
  GODOT_VERSION: 4.6
  RUST_VERSION: stable

jobs:
  build-and-upload:
    name: Build and Upload
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # LINUX x86_64
          - name: Linux (x86_64)
            platform: linux
            arch: x86_64
            os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu

          # LINUX ARM64 (Raspberry Pi native runner)
          - name: Linux (ARM64)
            platform: linux
            arch: arm64
            os: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu

          # MACOS x86_64
          - name: MacOS (x86_64)
            platform: macos
            arch: x86_64
            os: macos-latest
            target: x86_64-apple-darwin

          # MACOS ARM64
          - name: MacOS (ARM64)
            platform: macos
            arch: arm64
            os: macos-latest
            target: aarch64-apple-darwin

          # WINDOWS
          - name: Windows (x86_64)
            platform: windows
            arch: x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
      # ============================================
      # CLONE
      # ============================================
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Compute version
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="dev-${GITHUB_SHA::7}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # ============================================
      # RUST
      # ============================================
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.target }}

      # ============================================
      # CACHE
      # ============================================
      - uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      # ============================================
      # DEPS
      # ============================================
      - name: Install deps
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "linux" ]; then
            sudo apt-get update
            sudo apt-get install -y \
              libudev-dev \
              libusb-1.0-0-dev \
              libhidapi-dev \
              pkg-config \
              tree
          elif [ "${{ matrix.platform }}" = "macos" ]; then
            brew install tree
          fi

      # ============================================
      # BUILD DEBUG
      # ============================================
      - name: Build debug
        run: cargo build --target ${{ matrix.target }}

      - name: Archive debug
        shell: bash
        run: |
          addon="hid"
          bin="${addon}_ext"
          out="debug_build/addons/$addon/bin"
          mkdir -p $out

          if [ "${{ matrix.platform }}" = "linux" ]; then
            cp target/${{ matrix.target }}/debug/lib$bin.so $out/lib$bin.${{ matrix.platform }}.${{ matrix.arch }}.debug.so
          elif [ "${{ matrix.platform }}" = "macos" ]; then
            cp target/${{ matrix.target }}/debug/lib$bin.dylib $out/lib$bin.${{ matrix.platform }}.${{ matrix.arch }}.debug.dylib
          elif [ "${{ matrix.platform }}" = "windows" ]; then
            cp target/${{ matrix.target }}/debug/$bin.dll $out/lib$bin.${{ matrix.platform }}.${{ matrix.arch }}.debug.dll
          fi

          cat > $out/../$addon.gdextension << EOF
          [configuration]
          entry_symbol = "gdext_rust_init"
          compatibility_minimum = ${{ env.GODOT_VERSION }}
          reloadable = true

          [libraries]
          ${{ matrix.platform }}.${{ matrix.arch }}.debug = "bin/lib$bin.${{ matrix.platform }}.${{ matrix.arch }}.debug.${{ matrix.platform == 'windows' && 'dll' || matrix.platform == 'macos' && 'dylib' || 'so' }}"
          EOF

          name="$addon-${{ env.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-debug"
          cd debug_build
          tar -czf "../$name.tar.gz" addons
          echo "ASSET_DEBUG=$name.tar.gz" >> $GITHUB_ENV

      - name: Upload debug
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET_DEBUG }}
          overwrite_files: true

      # ============================================
      # BUILD RELEASE
      # ============================================
      - name: Build release
        run: cargo build --release --target ${{ matrix.target }}

      - name: Archive release
        shell: bash
        run: |
          addon="hid"
          bin="${addon}_ext"
          out="release_build/addons/$addon/bin"
          mkdir -p $out

          if [ "${{ matrix.platform }}" = "linux" ]; then
            cp target/${{ matrix.target }}/release/lib$bin.so $out/lib$bin.${{ matrix.platform }}.${{ matrix.arch }}.release.so
          elif [ "${{ matrix.platform }}" = "macos" ]; then
            cp target/${{ matrix.target }}/release/lib$bin.dylib $out/lib$bin.${{ matrix.platform }}.${{ matrix.arch }}.release.dylib
          elif [ "${{ matrix.platform }}" = "windows" ]; then
            cp target/${{ matrix.target }}/release/$bin.dll $out/lib$bin.${{ matrix.platform }}.${{ matrix.arch }}.release.dll
          fi

          cat > $out/../$addon.gdextension << EOF
          [configuration]
          entry_symbol = "gdext_rust_init"
          compatibility_minimum = ${{ env.GODOT_VERSION }}
          reloadable = true

          [libraries]
          ${{ matrix.platform }}.${{ matrix.arch }} = "bin/lib$bin.${{ matrix.platform }}.${{ matrix.arch }}.release.${{ matrix.platform == 'windows' && 'dll' || matrix.platform == 'macos' && 'dylib' || 'so' }}"
          EOF

          name="$addon-${{ env.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-release"
          cd release_build
          tar -czf "../$name.tar.gz" addons
          echo "ASSET_RELEASE=$name.tar.gz" >> $GITHUB_ENV

      - name: Upload release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET_RELEASE }}
          overwrite_files: true
