# Action name
name: Deploy

# Trigger on new tags or manual dispatch
on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
  workflow_dispatch:

permissions:
  contents: write

env:
  GODOT_VERSION: 4.6  # Godot 4.6 stable (January 2025)
  RUST_VERSION: stable

jobs:
  build-and-upload:
    name: Build and Upload
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # ============================================
          # LINUX
          # ============================================
          - name: Linux (x86_64)
            platform: linux
            arch: x86_64
            os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            cross: false

          # ðŸ†• NOUVEAU: Support Raspberry Pi 5
          - name: Linux (ARM64)
            platform: linux
            arch: arm64
            os: ubuntu-22.04
            target: aarch64-unknown-linux-gnu
            cross: true  # Cross-compilation nÃ©cessaire

          # ============================================
          # MACOS
          # ============================================
          - name: MacOS (x86_64)
            platform: macos
            arch: x86_64
            os: macos-latest
            target: x86_64-apple-darwin
            cross: false
        
          - name: MacOS (ARM64)
            platform: macos
            arch: arm64
            os: macos-latest
            target: aarch64-apple-darwin
            cross: false

          # ============================================
          # WINDOWS
          # ============================================
          - name: Windows (x86_64)
            platform: windows
            arch: x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            cross: false

    steps:
      # ============================================
      # SETUP
      # ============================================
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Compute version
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="dev-${GITHUB_SHA::7}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV


      # ðŸ†• Installation Rust moderne (sans actions-rs)
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
          toolchain: ${{ env.RUST_VERSION }}

      # ðŸ†• Cache Cargo pour accÃ©lÃ©rer les builds
      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache Cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-index-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-target-${{ matrix.target }}-

      # ============================================
      # DEPENDENCIES
      # ============================================
      - name: Install system dependencies
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "linux" ]; then
            set -eux

            # Mise Ã  jour standard pour x86_64
            sudo apt-get update -qq
            sudo apt-get install -qqq libudev-dev libusb-1.0-0-dev tree libhidapi-dev pkg-config

            # ðŸ†• Pour cross-compilation ARM64
            if [ "${{ matrix.cross }}" = "true" ]; then
              # Enable ARM64 architecture for multiarch packages
              sudo dpkg --add-architecture arm64

              # Fix des sources pour arm64 sur GitHub runners
              sudo sed -i 's|http://archive.ubuntu.com/ubuntu|http://ports.ubuntu.com/ubuntu-ports|g' /etc/apt/sources.list
              sudo sed -i 's|http://security.ubuntu.com/ubuntu|http://ports.ubuntu.com/ubuntu-ports|g' /etc/apt/sources.list

              sudo apt-get update -qq

              sudo apt-get install -qqq \
                gcc-aarch64-linux-gnu \
                g++-aarch64-linux-gnu \
                libhidapi-dev:arm64 \
                libudev-dev:arm64 \
                libusb-1.0-0-dev:arm64 \
                pkg-config:arm64

              # Pour pkg-config cross compilation
              export PKG_CONFIG_ALLOW_CROSS=1
              export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
            fi
          elif [ "${{ matrix.platform }}" = "macos" ]; then
            brew install tree
          fi

      # ðŸ†• Configuration cross-compilation pour ARM64
      - name: Configure cross-compilation
        if: matrix.cross == true
        shell: bash
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << EOF
          [target.aarch64-unknown-linux-gnu]
          linker = "aarch64-linux-gnu-gcc"
          EOF

      # ============================================
      # BUILD DEBUG
      # ============================================
      - name: Build binary files (debug)
        shell: bash
        run: |
          cargo build --verbose --target ${{ matrix.target }}

      - name: Archive files (debug)
        shell: bash
        run: |
          addon_name="hid"
          bin_dir="debug_build/addons/$addon_name/bin"
          bin_name="${addon_name}_ext"
          
          mkdir -p $bin_dir
          
          # Copier les binaires selon la plateforme
          if [ "${{ matrix.platform }}" = "linux" ]; then
            tree target/${{ matrix.target }}/debug/ || true

            bin_file_debug="lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.debug.so"
            cp target/${{ matrix.target }}/debug/lib$bin_name.so $bin_dir/$bin_file_debug

            # Debug info (si disponible)
            if [ -f "target/${{ matrix.target }}/debug/lib$bin_name.so.dwp" ]; then
              debug_info="lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.debug.so.dwp"
              cp target/${{ matrix.target }}/debug/lib$bin_name.so.dwp $bin_dir/$debug_info
            fi
            
          elif [ "${{ matrix.platform }}" = "macos" ]; then
            tree target/${{ matrix.target }}/debug/ || true

            bin_file_debug="lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.debug.dylib"
            cp target/${{ matrix.target }}/debug/lib$bin_name.dylib $bin_dir/$bin_file_debug

            # Debug symbols (si disponible)
            if [ -d "target/${{ matrix.target }}/debug/deps/lib$bin_name.dylib.dSYM" ]; then
              debug_info="lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.debug.dylib.dSYM"
              cp -r target/${{ matrix.target }}/debug/deps/lib$bin_name.dylib.dSYM $bin_dir/$debug_info
            fi
            
          elif [ "${{ matrix.platform }}" = "windows" ]; then
            bin_file_debug="lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.debug.dll"
            cp target/${{ matrix.target }}/debug/$bin_name.dll $bin_dir/$bin_file_debug

            # PDB debug symbols
            if [ -f "target/${{ matrix.target }}/debug/$bin_name.pdb" ]; then
              debug_info="lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.debug.pdb"
              cp target/${{ matrix.target }}/debug/$bin_name.pdb $bin_dir/$debug_info
            fi
          fi

          # ðŸ†• CrÃ©er .gdextension avec le bon entry_symbol pour gdext 0.3
          cat > $bin_dir/../$addon_name.gdextension << EOF
          [configuration]
          entry_symbol = "gdext_rust_init"
          compatibility_minimum = ${{ env.GODOT_VERSION }}
          reloadable = true

          [libraries]
          ${{ matrix.platform }}.${{ matrix.arch }}.debug = "bin/$bin_file_debug"

          [dependencies]
          ${{ matrix.platform }}.${{ matrix.arch }} = {}

          EOF

          archive_name="$addon_name-${{ env.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-debug"

          cd debug_build
          if [ "${{ matrix.platform }}" = "windows" ]; then
            7z a "../$archive_name.zip" "addons"
            echo "ASSET_DEBUG=$archive_name.zip" >> $GITHUB_ENV
          else
            tree addons || true
            tar -czvf "../$archive_name.tar.gz" "addons"
            echo "ASSET_DEBUG=$archive_name.tar.gz" >> $GITHUB_ENV
          fi

      # - name: Upload debug artifacts
      #   if: startsWith(github.ref, 'refs/tags/')
      #   uses: softprops/action-gh-release@v2
      #   with:
      #     files: |
      #       ${{ env.ASSET_DEBUG }}
      #     overwrite_files: true
      # ============================================
      # BUILD RELEASE
      # ============================================
      - name: Build binary files (release)
        shell: bash
        run: |
          cargo build --verbose --release --target ${{ matrix.target }}

      - name: Archive files (release)
        shell: bash
        run: |
          addon_name="hid"
          bin_dir="release_build/addons/$addon_name/bin"
          bin_name="${addon_name}_ext"
          
          mkdir -p $bin_dir
          
          # Copier les binaires selon la plateforme
          if [ "${{ matrix.platform }}" = "linux" ]; then
            bin_file_release="lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.release.so"
            cp target/${{ matrix.target }}/release/lib$bin_name.so $bin_dir/$bin_file_release
            
          elif [ "${{ matrix.platform }}" = "macos" ]; then
            bin_file_release="lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.release.dylib"
            cp target/${{ matrix.target }}/release/lib$bin_name.dylib $bin_dir/$bin_file_release
            
          elif [ "${{ matrix.platform }}" = "windows" ]; then
            bin_file_release="lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.release.dll"
            cp target/${{ matrix.target }}/release/$bin_name.dll $bin_dir/$bin_file_release
          fi

          # ðŸ†• CrÃ©er .gdextension avec le bon entry_symbol pour gdext 0.3
          cat > $bin_dir/../$addon_name.gdextension << EOF
          [configuration]
          entry_symbol = "gdext_rust_init"
          compatibility_minimum = ${{ env.GODOT_VERSION }}
          reloadable = true

          [libraries]
          ${{ matrix.platform }}.${{ matrix.arch }} = "bin/$bin_file_release"

          [dependencies]
          ${{ matrix.platform }}.${{ matrix.arch }} = {}

          EOF

          archive_name="$addon_name-${{ env.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-release"

          cd release_build
          if [ "${{ matrix.platform }}" = "windows" ]; then
            7z a "../$archive_name.zip" "addons"
            echo "ASSET_RELEASE=$archive_name.zip" >> $GITHUB_ENV
          else
            tree addons || true
            tar -czvf "../$archive_name.tar.gz" "addons"
            echo "ASSET_RELEASE=$archive_name.tar.gz" >> $GITHUB_ENV
          fi

      # - name: Upload release artifacts
      #   if: startsWith(github.ref, 'refs/tags/')
      #   uses: softprops/action-gh-release@v2
      #   with:
      #     files: |
      #       ${{ env.ASSET_RELEASE }}
      #     overwrite_files: true