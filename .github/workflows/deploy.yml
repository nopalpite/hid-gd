name: Deploy

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
  workflow_dispatch:

permissions:
  contents: write

env:
  GODOT_VERSION: 4.6
  RUST_VERSION: stable

jobs:
  build-and-upload:
    name: Build (${{ matrix.platform }} ${{ matrix.arch }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # LINUX
          - platform: linux
            os: ubuntu-24.04
            arch: x86_64

          - platform: linux
            os: ubuntu-24.04-arm
            arch: arm64

          # MACOS
          - platform: macos
            os: macos-latest
            arch: x86_64

          - platform: macos
            os: macos-latest
            arch: arm64

          # WINDOWS
          - platform: windows
            os: windows-latest
            arch: x86_64

    steps:
      # ============================================
      # CHECKOUT & VERSION
      # ============================================
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Compute version
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="dev-${GITHUB_SHA::7}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # ============================================
      # TARGET DETECTION
      # ============================================
      - name: Set Rust target
        shell: bash
        run: |
          case "${{ matrix.platform }}-${{ matrix.arch }}" in
            linux-x86_64)   TARGET=x86_64-unknown-linux-gnu ;;
            linux-arm64)    TARGET=aarch64-unknown-linux-gnu ;;
            macos-x86_64)   TARGET=x86_64-apple-darwin ;;
            macos-arm64)    TARGET=aarch64-apple-darwin ;;
            windows-x86_64) TARGET=x86_64-pc-windows-msvc ;;
            *) echo "Unsupported platform"; exit 1 ;;
          esac
          echo "TARGET=$TARGET" >> $GITHUB_ENV

      # ============================================
      # RUST
      # ============================================
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ env.TARGET }}

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-${{ matrix.arch }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-cargo-registry-

      - name: Cache Cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-${{ matrix.arch }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-cargo-index-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.arch }}-target-${{ env.TARGET }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-target-${{ env.TARGET }}-

      # ============================================
      # DEPENDENCIES
      # ============================================
      - name: Install system dependencies
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "linux" ]; then
            sudo apt-get update -qq
            sudo apt-get install -qqq \
              libudev-dev \
              libusb-1.0-0-dev \
              libhidapi-dev \
              pkg-config \
              tree
          elif [ "${{ matrix.platform }}" = "macos" ]; then
            brew install tree
          fi

      # ============================================
      # BUILD DEBUG
      # ============================================
      - name: Build (debug)
        shell: bash
        run: cargo build --verbose --target ${{ env.TARGET }}

      - name: Archive debug files
        shell: bash
        run: |
          addon_name="hid"
          bin_name="${addon_name}_ext"
          bin_dir="debug_build/addons/$addon_name/bin"

          mkdir -p "$bin_dir"

          ext="so"
          [ "${{ matrix.platform }}" = "macos" ] && ext="dylib"
          [ "${{ matrix.platform }}" = "windows" ] && ext="dll"

          # Définir le préfixe selon la plateforme
          prefix="lib"
          [ "${{ matrix.platform }}" = "windows" ] && prefix=""

          cp "target/${{ env.TARGET }}/debug/${prefix}$bin_name.$ext" \
             "$bin_dir/lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.debug.$ext"

          cat > "debug_build/addons/$addon_name/$addon_name.gdextension" << EOF
          [configuration]
          entry_symbol = "gdext_rust_init"
          compatibility_minimum = ${{ env.GODOT_VERSION }}
          reloadable = true

          [libraries]
          ${{ matrix.platform }}.${{ matrix.arch }}.debug = "bin/lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.debug.$ext"

          [dependencies]
          ${{ matrix.platform }}.${{ matrix.arch }} = {}
          EOF

          archive="hid-${{ env.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-debug"
          cd debug_build
          if [ "${{ matrix.platform }}" = "windows" ]; then
            7z a "../$archive.zip" addons
            echo "ASSET_DEBUG=$archive.zip" >> $GITHUB_ENV
          else
            tar -czvf "../$archive.tar.gz" addons
            echo "ASSET_DEBUG=$archive.tar.gz" >> $GITHUB_ENV
          fi

      - name: Upload debug artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET_DEBUG }}
          overwrite_files: true

      # ============================================
      # BUILD RELEASE
      # ============================================
      - name: Build (release)
        shell: bash
        run: cargo build --verbose --release --target ${{ env.TARGET }}

      - name: Archive release files
        shell: bash
        run: |
          addon_name="hid"
          bin_name="${addon_name}_ext"
          bin_dir="release_build/addons/$addon_name/bin"

          mkdir -p "$bin_dir"

          ext="so"
          [ "${{ matrix.platform }}" = "macos" ] && ext="dylib"
          [ "${{ matrix.platform }}" = "windows" ] && ext="dll"

          # Définir le préfixe selon la plateforme
          prefix="lib"
          [ "${{ matrix.platform }}" = "windows" ] && prefix=""

          cp "target/${{ env.TARGET }}/release/${prefix}$bin_name.$ext" \
             "$bin_dir/lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.release.$ext"

          cat > "release_build/addons/$addon_name/$addon_name.gdextension" << EOF
          [configuration]
          entry_symbol = "gdext_rust_init"
          compatibility_minimum = ${{ env.GODOT_VERSION }}
          reloadable = true

          [libraries]
          ${{ matrix.platform }}.${{ matrix.arch }} = "bin/lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.release.$ext"

          [dependencies]
          ${{ matrix.platform }}.${{ matrix.arch }} = {}
          EOF

          archive="hid-${{ env.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-release"
          cd release_build
          if [ "${{ matrix.platform }}" = "windows" ]; then
            7z a "../$archive.zip" addons
            echo "ASSET_RELEASE=$archive.zip" >> $GITHUB_ENV
          else
            tar -czvf "../$archive.tar.gz" addons
            echo "ASSET_RELEASE=$archive.tar.gz" >> $GITHUB_ENV
          fi

      - name: Upload release artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET_RELEASE }}
          overwrite_files: true