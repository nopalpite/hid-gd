# Action name
name: Deploy

# Trigger on new tags or manual dispatch
on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
  workflow_dispatch:

permissions:
  contents: write

env:
  GODOT_VERSION: 4.6
  RUST_VERSION: stable

jobs:
  build-and-upload:
    name: Build and Upload
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # LINUX x86_64
          - name: Linux (x86_64)
            platform: linux
            arch: x86_64
            os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            cross: false

          # LINUX ARM64 (Raspberry Pi 5)
          - name: Linux (ARM64)
            platform: linux
            arch: arm64
            os: ubuntu-22.04
            target: aarch64-unknown-linux-gnu
            cross: true

          # MACOS x86_64
          - name: MacOS (x86_64)
            platform: macos
            arch: x86_64
            os: macos-latest
            target: x86_64-apple-darwin
            cross: false

          # MACOS ARM64
          - name: MacOS (ARM64)
            platform: macos
            arch: arm64
            os: macos-latest
            target: aarch64-apple-darwin
            cross: false

          # WINDOWS x86_64
          - name: Windows (x86_64)
            platform: windows
            arch: x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            cross: false

    steps:
      # ============================================
      # SETUP
      # ============================================
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Compute version
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="dev-${GITHUB_SHA::7}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # Install Rust
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
          toolchain: ${{ env.RUST_VERSION }}

      # Cache Cargo
      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache Cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-index-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-target-${{ matrix.target }}-

      # ============================================
      # DEPENDENCIES
      # ============================================
      - name: Install system dependencies
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "linux" ]; then
            set -eux

            # x86_64 deps
            sudo apt-get update -qq
            sudo apt-get install -qqq libudev-dev libusb-1.0-0-dev tree libhidapi-dev pkg-config

            # ARM64 cross-compilation (Raspberry Pi)
            if [ "${{ matrix.cross }}" = "true" ]; then
              sudo apt-get update -qq
              # install cross compiler essentials
              sudo apt-get install -y crossbuild-essential-arm64 tree

              # Enable cross-compilation for pkg-config
              export PKG_CONFIG_ALLOW_CROSS=1
              export PKG_CONFIG_PATH=/usr/aarch64-linux-gnu/lib/pkgconfig
            fi

          elif [ "${{ matrix.platform }}" = "macos" ]; then
            brew install tree
          fi

      # Cargo cross-compilation config
      - name: Configure cross-compilation
        if: matrix.cross == true
        shell: bash
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << EOF
          [target.aarch64-unknown-linux-gnu]
          linker = "aarch64-linux-gnu-gcc"
          EOF

      # ============================================
      # BUILD DEBUG
      # ============================================
      - name: Build binary files (debug)
        shell: bash
        run: cargo build --verbose --target ${{ matrix.target }}

      - name: Archive debug files
        shell: bash
        run: |
          addon_name="hid"
          bin_dir="debug_build/addons/$addon_name/bin"
          bin_name="${addon_name}_ext"

          mkdir -p $bin_dir

          if [ "${{ matrix.platform }}" = "linux" ]; then
            tree target/${{ matrix.target }}/debug/ || true
            cp target/${{ matrix.target }}/debug/lib$bin_name.so $bin_dir/lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.debug.so
          elif [ "${{ matrix.platform }}" = "macos" ]; then
            cp target/${{ matrix.target }}/debug/lib$bin_name.dylib $bin_dir/lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.debug.dylib
          elif [ "${{ matrix.platform }}" = "windows" ]; then
            cp target/${{ matrix.target }}/debug/$bin_name.dll $bin_dir/lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.debug.dll
          fi

          # Create .gdextension
          cat > $bin_dir/../$addon_name.gdextension << EOF
          [configuration]
          entry_symbol = "gdext_rust_init"
          compatibility_minimum = ${{ env.GODOT_VERSION }}
          reloadable = true

          [libraries]
          ${{ matrix.platform }}.${{ matrix.arch }}.debug = "bin/lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.debug.${{ matrix.platform == 'windows' && 'dll' || matrix.platform == 'macos' && 'dylib' || 'so' }}"

          [dependencies]
          ${{ matrix.platform }}.${{ matrix.arch }} = {}
          EOF

          # Archive
          archive_name="$addon_name-${{ env.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-debug"
          cd debug_build
          if [ "${{ matrix.platform }}" = "windows" ]; then
            7z a "../$archive_name.zip" "addons"
            echo "ASSET_DEBUG=$archive_name.zip" >> $GITHUB_ENV
          else
            tar -czvf "../$archive_name.tar.gz" "addons"
            echo "ASSET_DEBUG=$archive_name.tar.gz" >> $GITHUB_ENV
          fi

      - name: Upload debug artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.ASSET_DEBUG }}
          overwrite_files: true

      # ============================================
      # BUILD RELEASE
      # ============================================
      - name: Build binary files (release)
        shell: bash
        run: cargo build --verbose --release --target ${{ matrix.target }}

      - name: Archive release files
        shell: bash
        run: |
          addon_name="hid"
          bin_dir="release_build/addons/$addon_name/bin"
          bin_name="${addon_name}_ext"

          mkdir -p $bin_dir

          if [ "${{ matrix.platform }}" = "linux" ]; then
            cp target/${{ matrix.target }}/release/lib$bin_name.so $bin_dir/lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.release.so
          elif [ "${{ matrix.platform }}" = "macos" ]; then
            cp target/${{ matrix.target }}/release/lib$bin_name.dylib $bin_dir/lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.release.dylib
          elif [ "${{ matrix.platform }}" = "windows" ]; then
            cp target/${{ matrix.target }}/release/$bin_name.dll $bin_dir/lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.release.dll
          fi

          # Create .gdextension
          cat > $bin_dir/../$addon_name.gdextension << EOF
          [configuration]
          entry_symbol = "gdext_rust_init"
          compatibility_minimum = ${{ env.GODOT_VERSION }}
          reloadable = true

          [libraries]
          ${{ matrix.platform }}.${{ matrix.arch }} = "bin/lib$bin_name.${{ matrix.platform }}.${{ matrix.arch }}.release.${{ matrix.platform == 'windows' && 'dll' || matrix.platform == 'macos' && 'dylib' || 'so' }}"

          [dependencies]
          ${{ matrix.platform }}.${{ matrix.arch }} = {}
          EOF

          # Archive
          archive_name="$addon_name-${{ env.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-release"
          cd release_build
          if [ "${{ matrix.platform }}" = "windows" ]; then
            7z a "../$archive_name.zip" "addons"
            echo "ASSET_RELEASE=$archive_name.zip" >> $GITHUB_ENV
          else
            tar -czvf "../$archive_name.tar.gz" "addons"
            echo "ASSET_RELEASE=$archive_name.tar.gz" >> $GITHUB_ENV
          fi

      - name: Upload release artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.ASSET_RELEASE }}
          overwrite_files: true
